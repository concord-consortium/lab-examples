<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.0.2/css/font-awesome.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet" type="text/css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="http://lab.dev.concord.org/lab/lab.iframe-phone.js"></script>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,300italic,400,300,700&amp;subset=latin,greek,latin-ext" rel="stylesheet" type="text/css">
    <style type="text/css">
      iframe#interactive-iframe {
         display: inline-block; }
      div#graph {
         display: inline-block;
         vertical-align: top;
         left-margin: 0.5em;
         background-color: #ddf2ff;
         border-radius: 0.25em;
         width: 460px;
         height: 375px; }
    </style>
  </head>
  <body>
    <h1>Controlling a interactive with a model changing selector</h1>
    <p>
      <p><b>This is currently broken</b></p>

      <p>
      Several interactives have multiple models. The interactive has a control, usually a radio button or pull down menu, which switches the model 
      being shown.  This example is embeds 
      <a href="http://lab.dev.concord.org/interactives.html#interactives/itsi/states-of-matter/atomic-movement-in-gases.json">
        Atomic Movement in Gases</a>
      </p>

      <p>
      First there is a checkbox for 'showing interactions', this checkbox is bound to the 'showVDWLines' property. So this page dispays the value
      of that, and allows setting or clearing it. Currently the setting and clearing works fine. But the observing of the property doesn't work
      after the model is changed.
      </p>
    </p>
    <iframe id="interactive-iframe" width="565px" height="435px"
            frameborder="no" scrolling="no" allowfullscreen="true"
            webkitallowfullscreen="true" mozallowfullscreen="true"
            src="http://lab.dev.concord.org/embeddable.html#interactives/itsi/states-of-matter/atomic-movement-in-gases.json">
    </iframe>
    <div>
      Value of 'showing interactions':<span id="showing-interactions-value">unknown</span>
      <a id="show-interactions">Show Interactions</a> <a id="hide-interactions">Hide Interactions</a>
    </div>
    <script>
      // call this function when jQuery thinks the page is ready 
      $(function() {
        // Intitialization
        var iframePhone = new Lab.IFramePhone($('#interactive-iframe')[0], modelLoadedCallback, connectedCallback);

        // handle links for showing and hiding interactions
        $('#show-interactions').click(function(){
          iframePhone.post({type: 'set', propertyName: 'showVDWLines', propertyValue: true});
        })
        $('#hide-interactions').click(function(){
          iframePhone.post({type: 'set', propertyName: 'showVDWLines', propertyValue: false});
        });

        // the iframe-phone library doesn't support observing properties very well
        // so instead a raw message listener is used here
        window.addEventListener('message', function(message) {
          var messageData;

          messageData = message.data;
          if (typeof messageData === 'string') {
            messageData = JSON.parse(messageData);
          }
          console.log("iframe message: type:" + messageData.type + " name:" + messageData.name);

          if (messageData.type == 'propertyValue'){
            if(messageData.name == 'showVDWLines'){
              $('#showing-interactions-value').html("" + messageData.values);
            }
          }
        }, false);

        function connectedCallback() {
          console.log('iframePhone connected');
        }

        function modelLoadedCallback() {
          // Model-specific setup:
          console.log('model loaded');

          // tell the interactive we want to observe the showVDWLines property
          iframePhone.post({type: 'observe', propertyName: 'showVDWLines'});

          var addListener = function (eventName) {
            iframePhone.addDispatchListener(eventName + ".parentFrame", function(values){
              console.log("got " + eventName);
            })
          };

          addListener('willReset');
          addListener('reset');
        }

        // Hints on how to set the currently loaded Model
        // on message 'loadModel' call controller.loadModel
        // parentMessageController.addListener('loadModel', function(message) {
        //   if (controller && controller.loadModel) {
        //     controller.loadModel(message.data.modelId, message.data.modelObject);
        //   }
        // });

      });
    </script>
</body>
</html>